(async function() { const statusDiv = document.createElement('div'); statusDiv.id = 'x-extractor-status'; statusDiv.style.cssText = 'position:fixed;top:20px;right:20px;background:#1d9bf0;color:white;padding:15px 20px;border-radius:8px;z-index:999999;font-family:system-ui;font-size:14px;box-shadow:0 4px 12px rgba(0,0,0,0.3);'; statusDiv.textContent = 'Extraction en cours...'; document.body.appendChild(statusDiv); const updateStatus = (msg) => { statusDiv.textContent = msg; }; const sleep = (ms) => new Promise(r => setTimeout(r, ms)); try { updateStatus('Recherche de l\'article...'); const article = document.querySelector('article'); if (!article) throw new Error('Article non trouvé sur cette page'); const articleContainer = article.closest('[data-testid="tweet"]') || article; const clone = articleContainer.cloneNode(true); ['[data-testid="reply"]', '[data-testid="retweet"]', '[data-testid="like"]', '[data-testid="bookmark"]', '[data-testid="share"]', '[role="group"]'].forEach(sel => { clone.querySelectorAll(sel).forEach(el => el.remove()); }); updateStatus('Extraction des styles...'); let styles = ''; for (const sheet of document.styleSheets) { try { for (const rule of sheet.cssRules || []) { styles += rule.cssText + '\n'; } } catch (e) {} } const bodyStyle = getComputedStyle(document.body); const bgColor = bodyStyle.backgroundColor || '#000'; const textColor = bodyStyle.color || '#fff'; const fontFamily = bodyStyle.fontFamily; updateStatus('Conversion des images...'); const images = clone.querySelectorAll('img'); let processed = 0; for (const img of images) { try { const response = await fetch(img.src); const blob = await response.blob(); const base64 = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); }); img.src = base64; processed++; updateStatus(`Conversion des images... ${processed}/${images.length}`); } catch (e) { console.warn('Image non convertie:', img.src); } } const elementsWithBg = clone.querySelectorAll('*'); for (const el of elementsWithBg) { const bg = el.style.backgroundImage; if (bg && bg.startsWith('url(')) { const urlMatch = bg.match(/url\(["']?([^"')]+)["']?\)/); if (urlMatch && urlMatch[1].startsWith('http')) { try { const response = await fetch(urlMatch[1]); const blob = await response.blob(); const base64 = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onloadend = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(blob); }); el.style.backgroundImage = `url("${base64}")`; } catch (e) {} } } } updateStatus('Génération du HTML...'); const html = `<!DOCTYPE html> <html lang="en"> <head> <meta charset="UTF-8"> <meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>X Article - ${new Date().toLocaleDateString()}</title> <style> * { box-sizing: border-box; } body { margin: 0; padding: 20px; background-color: ${bgColor}; color: ${textColor}; font-family: ${fontFamily || '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif'}; line-height: 1.5; } .article-container { max-width: 100%; margin: 0 auto; padding: 20px 40px; } img { max-width: 100%; height: auto; } ${styles} [style*="max-width: 600px"], [style*="max-width:600px"], [style*="max-width: 598px"], [style*="max-width:598px"] { max-width: 100% !important; } article, article > div { max-width: 100% !important; width: 100% !important; } </style> </head> <body> <div class="article-container"> ${clone.outerHTML} </div> </body> </html>`; updateStatus('Téléchargement...'); const fileName = `x-article-${Date.now()}.html`; const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent); if (isIOS && navigator.share) { const file = new File([html], fileName, { type: 'text/html' }); await navigator.share({ files: [file], title: 'X Article' }); } else { const blob = new Blob([html], { type: 'text/html' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = fileName; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); } updateStatus('✓ Terminé !'); await sleep(2000); statusDiv.remove(); } catch (error) { updateStatus('❌ Erreur: ' + error.message); await sleep(4000); statusDiv.remove(); } })();